# Scipion

## Spuštění Scipionu

Pokud nejste již přihlášeni, přihlaste se na [rancher.cloud.e-infra.cz](https://rancher.cloud.e-infra.cz), viz sekce [Rancher](../rancher/rancher).

Následujícími kroky můžete spustit aplikaci Scipion. Při instalaci aplikace budete vyzváni k zadání informací pro připojení Onedata. Tato aplikace nemá trvalá data, kromě připojených úložišť Onedata. To znamená, že pokud aplikaci odstraníte a později ji znovu nainstalujete, data, která jste uložili mimo připojení Onedata, budou ztracena. Chování za připojeními Onedata je popsáno níže.

### Poznámky

* Výchozí projekt měl kvótový limit pro 12 garantovaných CPU a kvótový limit pro 16 CPU. Nevybírejte více než 10 garantovaných CPU a více než 14 CPU. Pokud potřebujete více, jednoduše [se zeptejte](mailto:k8s@ics.muni.cz). To může být v budoucnu zvýšeno, takže žádost o více CPU může být podána.

* Pokud v kroku **Instalace aplikace** nevyberete `Přizpůsobit možnosti Helm před instalací`, instalace se zdá být neúspěšná, ale ve skutečnosti funguje po delší době.

### Vyberte aplikaci k spuštění

Ujistěte se, že jste nevybrali žádný namespace a vidíte `Pouze uživatelské namespace` (1) v horní části stránky Rancher.

Procházejte `App & Marketplace` (2), `Charts` (3) a vyberte `Scipion` (4). Viz screenshot níže.

![selectapp](/img/ceritsc/apps/scipion/rancher-apps.png)

### Vyberte verzi aplikace

Když kliknete na graf, můžete vybrat verzi aplikace, jak je znázorněno níže. Vyberte `Verzi grafu`, přesnou verzi Scipionu najdete pod `Verze aplikace`. Verze se mohou v průběhu času lišit. Klikněte na `Instalovat`, abyste pokračovali.

![selectversion](/img/ceritsc/apps/scipion/rancher-scipion.png)

### Nainstalujte aplikaci

Nyní můžete nainstalovat aplikaci Scipion. Vyberte `Namespace` (1) kromě `default`, vyplňte `Název` (2) vaší instance a klikněte na tlačítko `Další` (3), abyste pokračovali. Namespace `default` je k dispozici, ale neměl by být používán. **Mějte na paměti, že byste nyní neměli spouštět dvě nebo více instancí ve stejném `Namespace`.** Informace o vytvoření nového `Namespace` jsou k dispozici [zde](../rancher/quotas). **Pokud aplikaci odstraníte a později ji znovu nainstalujete, jakákoli data uložená mimo úložiště Onedata budou ztracena.**

![appinst](/img/ceritsc/apps/scipion/rancher-scipion-form.png)

Prvním prvkem, který je třeba vyplnit ve formuláři, je `noVNC heslo`, které budete potřebovat pro přístup k vzdálené ploše aplikace Scipion. Položky související s Onedata ve formuláři jsou popsány níže.

#### Onedata

Aplikace `Scipion-in-kubernetes` vyžaduje přístupové údaje k `Onedata` `prostorům`, které budou připojeny. Jsou vyžadovány dva různé `Onedata` `prostory`:
* `source` -- tento `prostor` by měl obsahovat zdrojová data k zpracování (např. data skenovaná CryoEM).
* `project` -- tento `prostor` by měl být prázdný nebo obsahovat existující projekt, se kterým chcete pracovat.

Další informace o technických podrobnostech připojení Onedata jsou popsány na konci tohoto dokumentu.

Položky Onedata, které je třeba vyplnit do formuláře, jsou následující:
* `Onedata hostitel` (Img. 1) -- Doména `poskytovatele`, který podporuje vaše `prostory` (Aplikace předpokládá stejného `poskytovatele` pro oba `prostory`).
* `Onedata space-ID pro zdrojová data` (Img. 2) -- ID vašeho `source` `prostor`.
* `Onedata token pro zdrojová data` (Img. 3) -- Token pro přístup k `source` `prostor`.
* `Onedata space-ID pro projektová data` (Img. 2) -- ID vašeho `project` `prostor`.
* `Onedata token pro projektová data` (Img. 3) -- Token pro přístup k `project` `prostor`.

![form](/img/ceritsc/apps/scipion/rancher-scipion-form2.png)

![form](/img/ceritsc/apps/scipion/onedata-host.png)
![form](/img/ceritsc/apps/scipion/onedata-spaceid.png)
![form](/img/ceritsc/apps/scipion/onedata-token.png)

### Počkejte, až se aplikace spustí

Když kliknete na `Instalovat`, uvidíte instalační protokol. Jakmile uvidíte `ÚSPĚCH` (viz screenshot níže), aplikace běží.

#### Poznámky

* Může trvat nějaký čas, než bude aplikace připravena, protože se stahuje velký docker obraz. Tato akce by měla být dokončena do 5 minut.

![apphelm](/img/ceritsc/apps/scipion/rancher-scipion-ready.png)

### Připojte se k běžící instanci

Jakmile aplikace běží, procházejte `Service Discovery` (1) a `Ingresses` (2) a otevřete odkaz `Target` (3).

Jelikož URL závisí pouze na namespace, který jste vybrali v předchozím kroku, můžete přeskočit hledání URL v Rancheru a přejít ve svém prohlížeči na URL ve formátu: `https://scipion.`*váš-namespace*`.dyn.cloud.e-infra.cz/`. Např., `https://scipion.handl-ns.dyn.cloud.e-infra.cz/`.

![apphelm](/img/ceritsc/apps/scipion/rancher-scipion-link.png)
![app](/img/ceritsc/apps/scipion/desktop-vnc.png)

Při připojení k vzdálené ploše aplikace budete vyzváni k zadání hesla vyplněného ve formuláři.

## Scipion

Když je instance spuštěna, můžete se připojit k vzdálené ploše, ale stále nemusíte být schopni používat Scipion, protože instance synchronizuje `source` a `project` data. Doba závisí na velikosti dat. U velmi velkých `source` dat (terabajty) to může trvat mnoho hodin. Pokud je tato *synchronizační fáze* stále v procesu, uvidíte její průběh místo desktopového prostředí. Desktopové prostředí se spustí po dokončení *synchronizační fáze*.


![app](/img/ceritsc/apps/scipion/desktop-cloning.png)
![app](/img/ceritsc/apps/scipion/desktop-xfce.png)

## Smazat běžící instanci

Pokud máte pocit, že aplikaci již nepotřebujete, můžete ji smazat. Stačí přejít na `App & Marketplace` (1), `Installed Apps` (2), vybrat aplikaci (3) a kliknout na `Delete` (4). Všechna data uložená mimo `Onedata` `storages` budou smazána.

![appdel](/img/ceritsc/apps/scipion/rancher-scipion-delete.png)

## Technické detaily o připojeních Onedata

Tato aplikace připojuje dvě `onedata` `spaces` -- první se nazývá `source` a druhý se nazývá `project`. Tyto připojené `spaces` však nejsou přímo přístupné z aplikace. Místo toho jsou synchronizovány na pozadí s `volumes` Kubernetes. Synchronizace funguje podle následující logiky:
* `source` `space` &rarr; `source` `volume` (jednosměrně) -- Data jsou klonována do objemu při spuštění.
* `project` `space` &harr; `project` `volume` (obousměrně) -- Tato synchronizace obsahuje 3 kroky:
    * Projekt (pokud existuje) je obnoven při spuštění (data jsou klonována ze `space` do `volume`)
    * Každých několik minut se spouští automatické ukládání (data jsou klonována z `volume` do `space`).
    * Při mazání aplikace obdrží synchronizační démon signál *stop* a provede konečné uložení projektu (data jsou klonována z `volume` do `space`).

Tyto dva `volumes` jsou připojeny v adresáři `/mnt`, ale pro pohodlí jsou symlinkovány z `~/ScipionUserData/source` a `~/ScipionUserData/projects`. Scipion implicitně používá adresář `~/ScipionUserData/projects` k ukládání dat projektu. Adresář `~/ScipionUserData/source` je navržen jako pouze pro čtení.

**Mějte prosím na paměti, že jakákoli data uložená mimo `project` `volume` (synchronizovaná s `project` `space`) budou ztracena, když bude aplikace smazána.**
