# Úložiště

Orchestrátor Kubernetes nabízí několik způsobů, jak využít infrastrukturu úložišť. Existují tři důležité objekty Kubernetes související s úložištěm: *Třída úložiště*, *Fyzické úložiště (PV)*, *Žádost o trvalé úložiště (PVC)*.

## Třída úložiště

[Třída úložiště](https://kubernetes.io/docs/concepts/storage/storage-classes/) poskytuje způsob, jak mohou administrátoři popsat "třídy" úložiště, které nabízejí. Různé třídy mohou odpovídat úrovním kvality služby. Nabízíme následující třídy úložiště:

1. csi-ceph-rbd-du -- třída úložiště podložená blokovými objemy CEPH RBD z DU CESNET. Blokový objem je formátován např. jako `ext4` místní souborový systém, který může být připojen k jednomu Podu.
2. nfs-csi -- výchozí dynamická třída, která používá NFS jako protokol připojení. Dynamická třída znamená, že objemy mohou být vytvářeny ad-hoc, jakmile je uživatel požaduje.
3. sshfs -- třída úložiště, která umožňuje použít protokol SSH k připojení k vzdálenému uzlu (ne nutně uzlu úložiště) a poskytuje souborový systém, který je připojen k Podu.

Tabulka níže popisuje výkonnostní charakteristiky každé třídy úložiště, kromě těchto tříd poskytujeme také charakteristiky CIFS úložiště, které je také dostupné, nikoli prostřednictvím *Třídy úložiště*, viz níže.

|Typ úložiště|Čtení IOPS|Zápis IOPS|Čtení lineárně|Zápis lineárně|
|:---|---:|---:|---:|---:|
|Místní SSD|98800|82800|1000MiB/s|947MiB/s|
|nfs-csi|30700|22000|755MiB/s|1093MiB/s|
|csi-ceph-rbd-du|496|814|224MiB/s|188MiB/s|
|sshfs|13400|41200|171MiB/s|179MiB/s|
|CIFS|19300|16900|372MiB/s|483MiB/s|

## PV

PV představuje fyzické úložiště, které je zodpovědné za připojení úložiště. Pouze administrátor může vytvořit PV a je to prostředek platný v celém clusteru (není jmenně oddělený).

## PVC

PVC představuje jakýsi trvalý úložný prostor, který může být připojen do *podu*. PVC jsou obvykle síťové objemy, např. NFS nebo CIFS/SMB. Tyto typy PVC mohou být připojeny k mnoha podech současně, čímž se stávají sdíleným úložištěm mezi podech.

* Uživatel může vytvořit ad-hoc PVC pomocí [pvc.yaml](deployments/pvc.yaml) šablony. Stáhněte ji a vyplňte správné hodnoty `name` a `storage` velikosti a zadejte příkaz:
```bash
kubectl create -f pvc.yaml -n namespace
```

    kde `namespace` je uživatelský jmenný prostor, jak je vidět v GUI Rancher, obvykle *surname-ns*. Ad-hoc pod neobsahuje žádná data předem, uživatel musí data naplnit sám. Název PVC je přesně stejný, jaký vyplníte do hodnoty `name`. Uživatel si může vybrat jinou třídu úložiště podle výše uvedeného popisu.

* Další možností je vytvořit PVC jako CIFS úložiště z CERIT-SC. V takovém případě uživatel musí stáhnout [secret.yaml](deployments/secret.yaml), vyplnit správné `name` a následující dvě anotace: `cerit.io/storage`, `cerit.io/share`. Tyto hodnoty z příkladu fungují pro *storage-brno12-cerit* tak, jak jsou, umožňují přístup k domovskému adresáři uživatele. Pro sdílení složek `project` musí být `cerit.io/share` nastaveno na: `cerit.io/share: 'export/nfs4/projects/project_name'`. Uživatel také musí vyplnit `mount_flags`. `mount_flags` je base64 kódovaný řetězec, který lze získat pomocí následujícího příkazu:
```bash
echo -n "username=USER,password=PASS,uid=1000,gid=1000,nosetuids,vers=3.11,noserverino" | base64
```
    kde `USER` a `PASS` jsou uživatelské jméno a heslo pro přístup k *storage-brno12-cerit*, resp. V případě, že je `USER` UČO, je třeba přidat `domain=UCN` do příkazu `echo` jako další hodnotu oddělenou čárkou, tj.
```bash
echo -n "username=USER,password=PASS,uid=1000,gid=1000,nosetuids,vers=3.11,noserverino,domain=UCN" | base64
```

    Pokud neznáte CIFS heslo pro úložiště CERIT-SC, jednoduše si o něj požádejte na [support@cerit-sc.cz](mailto: support@cerit-sc.cz). Není to **stejné** heslo, které používáte pro přihlášení do infrastruktury!

    Mějte na paměti, že base64 kódovaný řetězec není šifrovaný, takže si ho uchovejte v tajnosti!

    Jakmile uživatel vytvoří soubor secret.yaml, musí být nahrán do Kubernetes pomocí následujícího příkazu:
```bash
kubectl create -f secret.yaml -n namespace
```
    `namespace` je stejný jako v předchozím případě. Název PVC je odvozen z hodnoty `name` a bude: `pvc-name`. V tomto případě PVC nebude prázdné, obsahuje data z vašeho domova z úložiště-brno12-cerit.

* Poslední možností je požádat administrátory, aby pro vás vytvořili speciální PVC podle vašich potřeb. Můžete o to požádat na [k8s@ics.muni.cz](mailto: k8s@ics.muni.cz).

Svou PVC vidíte v GUI Rancher v `Storage` &rarr; `PersistentVolumeClaims` ![Volumes](/img/ceritsc/pvc.jpg)

## Vlastní PVC třídy

V naší infrastruktuře poskytujeme několik vlastních PVC tříd úložiště pro použití s úložnými službami, které poskytujeme. V této části uvádíme tyto třídy a vysvětlujeme, jak je používat.

### WebDAV

Tato třída úložiště vám umožňuje přístup k WebDAV úložišti. Například někteří poskytovatelé cloudového úložiště mají tuto funkci. WebDAV přistupuje k úložným souborům prostřednictvím protokolu HTTP a je proto poměrně pomalý; pokud máte jinou možnost, jak přistupovat k vašim datům, doporučujeme ji použít pro zajištění lepšího výkonu.

Pro přístup k WebDAV úložišti budete potřebovat:
  - WebDAV URL
  - adresář pro připojení
  - uživatelské jméno
  - heslo

Existují 2 způsoby, jak poskytnout heslo. Buď přidejte heslo přímo do specifikace PVC (DŮRAZNĚ ODPOURÁNO), nebo uložte heslo do tajemství a poté specifikujte název tajemství ve specifikaci PVC. Ukážeme příklad druhého přístupu.

```yaml filename="manifests.yaml" copy
apiVersion: v1
kind: Secret
metadata:
  name: my-webdav-secret
  namespace: my-ns
type: Opaque
stringData:
  password: SuperSecretPassword
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: my-webdav-pvc
  namespace: my-ns
  annotations:
    url: "https://my.webdav.url/remote.php/dav/files/123456789"
    dir: "directory_to_mount"
    user: "my_username"
    passwordSecret: "my-webdav-secret" # this is the name of the secret created a few lines above
spec:
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 100Gi
  storageClassName: webdav
```

Nahraďte `password`, `url`, `dir`, `user`, `passwordSecret` a všechny názvy a prostory názvů svými hodnotami. S tímto yaml souborem byste měli být schopni úspěšně vytvořit PVC, které lze připojit uvnitř vašich podů.

## Ephemeral Storage

Ephemeral typ úložiště je alokován z místního úložiště uzlu. Alokace se provádí prostřednictvím požadavků na zdroje, viz [resources](/kubernetes/resources) a prostřednictvím připojení objemů.

Ephemeral úložiště může být alokováno z místního disku nebo místní paměti. Pokud je Pod vyhozen nebo přesunut na jiný uzel, obsah ephemeral úložiště je ztracen.

Ephemeral úložiště z místního disku:

```yaml copy
volumes:
- name: eph
  emptyDir:
    sizeLimit: 10Gi

volumeMounts:
- name: eph
  mountPath: /data
```

Ephemeral úložiště z místní paměti:

```yaml copy
volumes:
- name: mem
  emptyDir:
    medium: Memory
    sizeLimit: 1Gi

volumeMounts:
- name: mem
  mountPath: /tmp
```

V případě místní paměti se podívejte na požadavky na [memory resources](/kubernetes/resources).
