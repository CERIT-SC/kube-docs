# Kubectl

## Exponování aplikací

V podstatě existují dva typy exponovaných aplikací: *webové* aplikace a *ostatní* aplikace. Rozdíl mezi těmito typy je v požadované IP adrese. Webová aplikace sdílí IP adresu s jinými webovými aplikacemi, zatímco ostatní aplikace potřebují novou IP adresu pro každou službu. Počet IP adres je omezený, takže pokud je to možné, použijte webový přístup.

V následující dokumentaci jsou fragmenty YAML, které mají být nasazeny pomocí `kubectl` takto: `kubectl create -f file.yaml -n namespace`, kde `file.yaml` obsahuje níže uvedené YAML a `namespace` je prostor názvů obsahující aplikaci. Tato část dokumentace také předpokládá, že aplikace (nasazení) již existuje. Pokud si nejste jisti, přečtěte si znovu [hello example](kubectl-helloworld.html).

### Webové aplikace

Webové aplikace jsou ty, které komunikují pomocí protokolu `HTTP`. Tyto aplikace jsou exponovány pomocí pravidel `Ingress`.

Celková architektura je znázorněna na této obrázku:
![Networking](/img/ceritsc/ingress.png)

Tento typ aplikace vyžaduje službu, která váže port na aplikaci, a pravidla ingress, která exponují službu na Internet.

Předpokládejme, že máme aplikaci, která je připravena běžet na portu 8080. Vytvoříme službu:
```yaml filename="service.yaml" copy
apiVersion: v1
kind: Service
metadata:
  name: application-svc
spec:
  type: ClusterIP
  ports:
  - name: application-port
    port: 80
    targetPort: 8080
  selector:
    app: application
```

Kde `selector:` `app: application` musí odpovídat názvu aplikace v nasazení a `application-svc` a `application-port` jsou libovolné názvy.

Jakmile máme službu, vytvoříme ingress:

```yaml filename="ingress.yaml" copy
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: application-ingress
  annotations:
    kubernetes.io/ingress.class: "nginx"
    kubernetes.io/tls-acme: "true"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
  tls:
    - hosts:
        - "application.dyn.cloud.e-infra.cz"
      secretName: application-dyn-clout-e-infra-cz-tls
  rules:
  - host: "application.dyn.cloud.e-infra.cz"
    http:
      paths:
      - backend:
          service:
            name: application-svc
            port:
              number: 80
        pathType: ImplementationSpecific
```

Kde `service` `name: application-svc` musí odpovídat názvu metadata *Service*. Tento *Ingress* exponuje aplikaci na webové URL `application.dyn.cloud.e-infra.cz`. Poznámka: doménové jméno bude automaticky registrováno, pokud je v doméně `dyn.cloud.e-infra.cz`. Sekce `tls` vytváří certifikát Lets Encrypt, není potřeba ho udržovat.

Pokud je použita sekce `tls`, TLS bude ukončeno na NGINX Ingress. Aplikace musí být nastavena na komunikaci přes `HTTP`. Komunikace mezi Kubernetes a uživateli probíhá přes `HTTPS`.

‼️  *DŮLEŽITÉ*

TLS je ukončeno na hranici clusteru při použití NGINX Ingress. Komunikace uvnitř clusteru není šifrována, zejména uvnitř jednoho uzlu clusteru. Pokud je to problém, uživatel musí vynechat sekce `tls` a `anotations` a poskytnout certifikát a klíč samotnému Podu.

‼️  *DŮLEŽITÉ*

Některé aplikace jsou zmatené, když jsou nakonfigurovány jako `HTTP`, ale exponovány jako `HTTPS`. Pokud aplikace generuje absolutní URL, musí generovat `HTTPS` URL, nikoli `HTTP`. Kubernetes Ingress nastavuje hlavičku `HTTP_X_SCHEME` na `HTTPS`, pokud je TLS ukončeno. Například pro *django* musí uživatel nastavit `SECURE_PROXY_SSL_HEADER = ("HTTP_X_SCHEME", "https")`. Běžná hlavička používaná pro tuto situaci je `X_FORWARDED_PROTO`, ale ta není nastavena Kubernetes NGINX. Je také možné exponovat aplikace nakonfigurované pro `HTTPS`. Viz *HTTPS target* níže.

#### Vlastní doménové jméno (FQDN)

Je také možné použít vlastní doménové jméno (v podstatě jakékoli jméno).

1. Je vyžadován DNS záznam `CNAME`. Pro `kuba-cluster` je cílový `CNAME` `kuba-pub.cerit-sc.cz`.
2. Objekt Ingress je ve formě:

```yaml filename="ingress.yaml" copy
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: application-ingress
  annotations:
    kubernetes.io/ingress.class: "nginx"
    kubernetes.io/tls-acme: "true"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
  tls:
    - hosts:
        - "my-name"
      secretName: my-name-tls
  rules:
  - host: "my-name"
    http:
      paths:
      - backend:
          service:
            name: application-svc
            port:
              number: 80
        pathType: ImplementationSpecific
```

##### Poznámka

`CNAME` musí být předem nastaven a propagován, aby služba Let's Encrypt mohla ověřit doménu, když je TLS požadováno. To znamená, že bezproblémová migrace z jakéhokoli systému na naši infrastrukturu není snadno možná.

#### Autentizace

`Ingress` může vyžadovat autentizaci uživatele, aby poskytl omezený přístup k *Service*. Autentizaci lze nastavit pomocí `Secret` a anotací.

Nejprve nastavte tajemství:
```yaml filename="secret.yaml" copy
apiVersion: v1
kind: Secret
metadata:
  name: secretref
type: Opaque
data:
   auth: password
```
Kde `secretref` je libovolný název a heslo je `base64` kódované `htpasswd`. Heslo lze vygenerovat tímto příkazem: `htpasswd -n username | base64 -w0`, kde `username` je požadované uživatelské jméno pro přihlášení. Vrátí text jako `Zm9vOiRhcHIxJGhOZVRzdngvJEkyVk9NbEhHZDE1N1gvYTN2aktYSDEKCg==`, který bude použit místo `hesla` v tajemství výše.

Následující dvě anotace jsou vyžadovány v `Ingress`.

```yaml copy
    nginx.ingress.kubernetes.io/auth-type: basic
    nginx.ingress.kubernetes.io/auth-secret: secretref
```

`secretref` musí odpovídat názvu metadata `Secret`.

‼️  *DŮLEŽITÉ*

Ochrana heslem se vztahuje pouze na externí provoz, tj. uživatel bude vyzván k zadání hesla. Provoz z jiných podů však obejde autentizaci, pokud komunikuje přímo s IP `Service`. To lze zmírnit použitím `Network Policy`. Viz [Bezpečnost](/kubernetes/security).

#### Nahrávání velkých dat

Pokud se očekává nahrávání velkých dat, mohou být vyžadovány následující dvě anotace `Ingress`, aby se vyřešil limit velikosti nahrávání.
```yaml copy
nginx.ingress.kubernetes.io/proxy-body-size: "600m"
nginx.org/client-max-body-size: "600m"
```

Nahraďte hodnotu `600m` požadovanou maximální velikostí nahrávání.

#### Cíl HTTPS

Objekt Ingress může vystavit aplikace, které používají protokol HTTPS místo HTTP, tj. komunikace mezi ingress a aplikací je také šifrovaná. V tomto případě je nutné přidat anotaci `nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"` do objektu ingress.

#### Omezování přístupu

Je možné omezit přístup k webové aplikaci na úrovni ingress tím, že omezíte přístup z konkrétního rozsahu IP adres. To se provádí pomocí anotace `Ingress` `nginx.ingress.kubernetes.io/whitelist-source-range`, následující příklad omezuje přístup pouze z MUNI sítě.

```yaml filename="ingress.yaml" copy
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: application-ingress
  annotations:
    kubernetes.io/ingress.class: "nginx"
    kubernetes.io/tls-acme: "true"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/whitelist-source-range: 147.251.0.0/16
spec:
  tls:
    - hosts:
        - "my-name"
      secretName: my-name-tls
  rules:
  - host: "my-name"
    http:
      paths
      - backend:
          service:
            name: application-svc
            port:
              number: 80
        pathType: ImplementationSpecific

```

#### Ladění: Certifikát nebyl vydán

Pokud jste vše nakonfigurovali podle dokumentace, certifikát by měl být vydán během několika okamžiků. Pokud certifikát nebyl vydán, je možné, že pod, který má sloužit `acme-challenge` (a tím vydat certifikát), nemůže být nasazen ve vaší namespace kvůli plné kvótě zdrojů namespace. Tento nový pod vyžaduje `100MiB` paměti a `100m` CPU, takže pokud je vaše namespace plně rezervována, zkuste zvýšit [kvótu zdrojů namespace](/rancher/quotas#changing-namespace-quotas) (přidejte `100` k rezervaci paměti a limitu paměti; přidejte `100` k rezervaci CPU a limitu CPU) nebo odeberte některé nasazení z namespace.

Pokud máte nainstalovaný `kubectl`, můžete zkontrolovat, zda je to problém:
1. Zkontrolujte, zda je vytvoření Ingress zaseknuto na acme-solver (`kubectl get ingress -n [your_namespace]` vrátí řádek obsahující `cm-acme-http-solver`)
```bash
> kubectl get ingress -n [your_namespace]
NAME                        CLASS    HOSTS                                                                             ADDRESS                PORTS     AGE
cm-acme-http-solver-972p9   <none>   schema.biodata.ceitec.cz                                                          kuba-pub.cerit-sc.cz   80        12m
```
2. Vylistujte události, které se dějí ve vaší namespace, a zjistěte, zda je tam varování o kvótách (`kubectl get events -n [your_namespace]` bude obsahovat některé řádky s `exceeded quota`)
```bash
> kubectl get events -n [your_namespace] | grep cm-acme-http-solver
...
79s         Warning   PresentError   challenge/adamant-dyn-cloud-e-infra-cz-6dp4n-152868974-3440702542   (combined from similar events): Error presenting challenge: pods "cm-acme-http-solver-74szl" is forbidden: exceeded quota: default-kn7vq, requested: limits.cpu=100m, used: limits.cpu=1, limited: limits.cpu=1
...
```

Události lze zkontrolovat také z uživatelského rozhraní Rancher.

![acmesolver](/img/ceritsc/acme-solver.png)


### Další aplikace

Aplikace, které nepoužívají protokol `HTTP`, jsou vystaveny přímo prostřednictvím `Service`.

```yaml filename="service.yaml" copy
apiVersion: v1
kind: Service
metadata:
  name: application-svc
  annotations:
    external-dns.alpha.kubernetes.io/hostname: application.dyn.cloud.e-infra.cz
spec:
  type: LoadBalancer
  ports:
  - port: 22
    targetPort: 2222
  selector:
    app: application
```

Kde `selector:` `app: application` musí odpovídat názvu aplikace v nasazení a `application-svc` je libovolný název. Pokud je poskytnuta anotace `external-dns.alpha.kubernetes.io/hostname` a hodnota je v doméně `dyn.cloud.e-infra.cz`, název bude zaregistrován v DNS.

Nasazení tohoto *Service* vystavuje aplikaci na veřejné IP. Můžete zkontrolovat IP pomocí `kubectl get svc -n namespace`, kde `namespace` je namespace služby a aplikace.

Je také možné vystavit aplikaci na soukromé IP MUNI. V tomto případě bude aplikace dostupná z MUNI sítě nebo pomocí MUNI VPN. Tento typ vystavení se vybírá pomocí anotace `metallb.universe.tf/address-pool: privmuni`. Tento případ je preferován, protože nepoužívá veřejnou IP. Úplný příklad je níže.

```yaml filename="service.yaml" copy
apiVersion: v1
kind: Service
metadata:
  name: application-svc
  annotations:
    metallb.universe.tf/address-pool: privmuni
    external-dns.alpha.kubernetes.io/hostname: application.dyn.cloud.e-infra.cz
spec:
  type: LoadBalancer
  ports:
  - port: 22
    targetPort: 2222
  selector:
    app: application
```
