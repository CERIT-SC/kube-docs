# Bezpečnostní Kontext

Kubernetes verze 1.25 se blíží a na tuto verzi se upgradujeme na začátku července 2023. S tímto vydáním je [PSP](https://kubernetes.io/docs/concepts/security/pod-security-policy/) zastaralé a bude odstraněno. Místo PSP se použije [PSA](https://kubernetes.io/docs/concepts/security/pod-security-admission/). I když je tato změna v podstatě záležitostí správy Kubernetes a není přímo spojena s uživateli, stále je vyžadována akce uživatele.

PSP měla mutující bezpečnostní politiku, což znamená, že jakékoli chybějící bezpečnostní možnosti v manifestu nasazení byly injektovány do manifestu a uživatelé si nevšimnou, že byl manifest změněn. PSA pouze validuje politiku, takže všechny požadované bezpečnostní možnosti musí být přidány uživatelem před nasazením.

Všechny bezpečnostní možnosti jsou specifikovány v `securityContext`. Existují dva bezpečnostní kontexty: (1) bezpečnostní kontext Podu a (2) bezpečnostní kontext kontejneru. Bezpečnostní kontext Podu je na stejné úrovni jako kontejner, bezpečnostní kontext kontejneru je uvnitř všech kontejnerů Podu.

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: example
spec:
  replicas: 1
  selector:
    matchLabels:
      app: example
  template:
    metadata:
      labels:
        app: example
    spec:
      securityContext: # Pod security context
        fsGroupChangePolicy: OnRootMismatch
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault
      containers:
      - image: ubuntu
        name: example
        securityContext: # Container security context
          runAsUser: 1000
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
```

Důležité nové možnosti pro bezpečnostní kontext Podu jsou následující:
```yaml
runAsNonRoot: true
seccompProfile:
  type: RuntimeDefault
```

`fsGroupChangePolicy: OnRootMismatch` není povinné, ale důrazně se doporučuje přidat, aby nedošlo k problémům při připojování PVC.

Důležité nové možnosti pro bezpečnostní kontext kontejneru jsou následující:
```yaml
allowPrivilegeEscalation: false
capabilities:
  drop:
  - ALL
```

Bez všech těchto důležitých možností budou nasazení/daemonsety/cronjoby/úlohy/pody po upgradu selhávat. Všechny možnosti lze přidat nyní.

Pokud spouštíte jakoukoli aplikaci CERIT-SC z Rancheru, je vyžadován upgrade na nejnovější verzi. Opět, to lze provést nyní.
