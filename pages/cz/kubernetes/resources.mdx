# GPU a další zdroje

## Požadavky a limity

Jak je popsáno v [dokumentaci Kubernetes](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/), platforma používá dva druhy "limitů" zdrojů. Jeden se nazývá *Požadavky* a poskytuje zaručené množství zdroje, druhý se nazývá *Limity* a specifikuje maximální limit zdroje, který nesmí být překročen. Uživatel může specifikovat pouze *Požadavky*, což umožňuje záruky bez limitu (což je na naší platformě zakázáno), nebo pouze *Limity*, a v tomto případě jsou *Požadavky* a *Limity* rovny. Všechny zdroje jsou alokovány z jednoho výpočetního uzlu, což znamená, že nemohou být větší než kapacita jednoho uzlu, např. požadavek na 1000 CPU nikdy nebude splněn. Zdroje mezi *Požadavky* a *Limity* nejsou zaručeny. Plánovač Kubernetes zohledňuje pouze *Požadavky* při plánování Podů na uzly, takže se může stát, že uzel zažije tlak na disk nebo paměť způsobený nadměrným využíváním těchto druhů zdrojů. V tomto případě může být Pod vyhozen z uzlu. U CPU zdrojů mezi *Požadavky* a *Limity* může dojít ke zpomalení, pokud uzel již nemá volné CPU.

Obecný fragment YAML vypadá takto:
```yaml
resources:
  requests:
  # resources
  limits:
  # resources
```

## CPU

CPU zdroj může být požadován v celých jednotkách CPU, jako je `2` pro dvě CPU, nebo v mili jednotkách, jako je `100m` pro 0.1 CPU. Viz kompletní příklad níže.

## Paměť

Paměťový zdroj může být požadován v bajtech nebo násobcích binárních bajtů. Notace je `1000Mi` nebo `1Gi` pro 1GB paměti. Množství tohoto zdroje zahrnuje sdílenou paměť (viz níže) a všechny paměťové objemy `emptyDir`. Následující příklad spotřebovává až 1GB paměťového zdroje a pokud aplikace vyžaduje např. 2GB paměti, uživatel musí požádat o 3GB paměťového zdroje.

```yaml
volumes:
- name ramdisk
  emptyDir:
   medium: Memory
   sizeLImit: 1Gi
```

### Sdílená paměť

Ve výchozím nastavení každý kontejner běží s limitem 64MB na [sdílenou paměť](https://man7.org/linux/man-pages/man7/shm_overview.7.html). V mnoha případech je tento limit dostatečný, ale pro některé GPU aplikace nebo GUI aplikace tato částka nestačí. V takovém případě je třeba zvýšit velikost SHM. To nelze provést v sekci `resource`, jedinou možností je připojit další paměťový objem pomocí následujícího fragmentu YAML, který zvyšuje velikost SHM na 1GB:

```yaml
volumes:
- name: dshm
  emptyDir:
    medium: Memory
    sizeLimit: 1Gi

volumeMounts:
- name: dshm
  mountPath: /dev/shm
```

`Název` objemu není důležitý a může být jakýkoli platný, `mountPath` musí být `/dev/shm`.

## GPU

GPU zdroj může být požadován dvěma odlišnými způsoby. Uživatel může požadovat GPU výhradně pomocí `nvidia.com/gpu: x`, kde `x` je číslo označující počet požadovaných GPU. Uživatel může také požadovat pouze část GPU pomocí `nvidia.com/mig-1g.10gb: x`, kde `x` je číslo takových částí GPU, nebo `nvidia.com/mig-2g.20gb: x`. `nvidia.com/mig-1g.10gb` požaduje část GPU s velikostí paměti 10GB, `nvidia.com/mig-2g.20gb` požaduje část GPU s velikostí paměti 20GB. Více informací o frakcích GPU (MIG) lze nalézt [zde](https://docs.nvidia.com/datacenter/tesla/mig-user-guide/index.html).

## Úložiště

Uživatel by měl také specifikovat požadovaný zdroj `ephemeral-storage`. Jednotky jsou stejné jako pro zdroj `paměť`. Tento zdroj označuje limit na místním úložišti, které zahrnuje velikost běžícího kontejneru a všech místních souborů vytvořených. Tyto soubory zahrnují všechny dočasné soubory v kontejneru, jako jsou soubory v adresářích `/tmp` nebo `/var/tmp`, a také všechny objemy `emptyDir`, které nejsou v paměti.

## Kompletní příklad zdrojů

Následující příklad požaduje 1 GPU, 2 CPU a 4GB paměti zaručeně, a 3 CPU a 6GB paměti jako tvrdý limit.

```yaml
resources:
  requests:
    cpu: 2
    memory: 4Gi
    nvidia.com/gpu: 1
  limits:
    cpu: 3
    memory: 6Gi
    nvidia.com/gpu: 1
```

Následující příklad požaduje 2 GB GPU paměti, 0.5 CPU a 4GB paměti zaručeně a také jako tvrdý limit.

```yaml
resources:
  requests:
    cpu: 500m
    memory: 4Gi
    nvidia.com/mig-1g.10gb: 1
  limits:
    cpu: 500m
    memory: 4Gi
    nvidia.com/mig-1g.10gb: 1
```
