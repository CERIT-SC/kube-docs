# Bezpečnost a síťová politika

## Autentizace Ingress

Pokud chce uživatel využít základní autentizaci nebo oauth na ingress, může to být provedeno, jak je popsáno v [oficiální dokumentaci](https://kubernetes.github.io/ingress-nginx/examples/auth/basic/) nebo v [naší dokumentaci](/kubernetes/expose).

Tento přístup má jednu velkou bezpečnostní chybu. Autentizace je vyžadována pouze při připojení přes ingress, tj. z vnější strany Kubernetes clusteru. Uživatel platformy se však může také připojit přímo z vnitřku clusteru k odpovídající službě (musí však uhodnout její IP) a v takovém případě není autentizace vyžadována.

Tato chyba může být zmírněna pomocí [síťové politiky](https://kubernetes.io/docs/concepts/services-networking/network-policies/), která může omezit původ síťového provozu. V tomto případě je užitečné povolit příchozí provoz na server pouze z *kube-system* namespace. Namespace *kube-system* hostí instanci Ingress Nginx, proto je vyžadováno připojení pouze z tohoto a pouze tohoto namespace.

Příklad síťové politiky lze [stáhnout zde](deployments/netpolicy.yaml). Tato politika umožňuje příchozí provoz z *kube-system* do Podu s názvem `myapp`. Tato politika je aplikována na *namespace*, kde se Pod `myapp` nachází.

## E-infra Single Sign On (BETA)

Je možné využít SSO službu e-infra k zabezpečení vaší aplikace. Abychom to umožnili, je třeba přidat některá data do ingressu.
Ukážeme, jak upravit existující ingress, aby zahrnoval SSO.

Tento příklad představuje existující ingress:

```yaml filename="ingress.yaml" copy
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-name
  annotations:
    kubernetes.io/ingress.class: "nginx"
    kubernetes.io/tls-acme: "true"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
  tls:
    - hosts:
        - "hostname.dyn.cloud.e-infra.cz"
      secretName: hostname-dyn-cloud-e-infra-cz-tls
  rules:
  - host: "hostname.dyn.cloud.e-infra.cz"
    http:
      paths:
      - path: /
        backend:
          service:
            name: service-name
            port:
              number: port-number
        pathType: Prefix
```

Nejprve musíme přidat několik anotací do samotného ingressu:

```yaml {9,10}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-name
  annotations:
    kubernetes.io/ingress.class: "nginx"
    kubernetes.io/tls-acme: "true"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
+   nginx.ingress.kubernetes.io/auth-url: "https://$host/oauth2/auth?allowed_emails=email1@ics.muni.cz, email2@ics.muni.cz, email3@ics.muni.cz"
+   nginx.ingress.kubernetes.io/auth-signin: "https://$host/oauth2/start?rd=$scheme%3A%2F%2F$host$escaped_request_uri"
spec:
  tls:
    - hosts:
        - "hostname.dyn.cloud.e-infra.cz"
      secretName: hostname-dyn-cloud-e-infra-cz-tls
  rules:
  - host: "hostname.dyn.cloud.e-infra.cz"
    http:
      paths:
      - path: /
        backend:
          service:
            name: service-name
            port:
              number: service-port-number
        pathType: Prefix
```

Anotace `nginx.ingress.kubernetes.io/auth-url` obsahuje dotazovací řetězec,
který specifikuje seznam uživatelů, kteří by měli mít přístup na webovou stránku,
změňte pouze seznam e-mailů v tomto poli, URL neměňte žádným způsobem.

Druhá anotace jednoduše říká ingressu, že by se měl po autentizaci uživatele přesměrovat zpět na webovou stránku.

Nyní, když je ingress nakonfigurován pro použití SSO endpointu, musíme nakonfigurovat
samotný SSO endpoint. K tomu musíme aplikovat následující YAML soubor:

```yaml copy
apiVersion: v1
kind: Service
metadata:
  name: ingress-name-oauth
spec:
  type: ExternalName
  externalName: oauth2-proxy.kube-system.svc.cluster.local
  ports:
  - name: http
    port: 4180
    protocol: TCP

---

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-name-oauth
  annotations:
    kubernetes.io/ingress.class: "nginx"
    kubernetes.io/tls-acme: "true"
spec:
  tls:
    - hosts:
        - "hostname.dyn.cloud.e-infra.cz"
      secretName: hostname-dyn-cloud-e-infra-cz-tls
  rules:
  - host: "hostname.dyn.cloud.e-infra.cz"
    http:
      paths:
      - path: /oauth2
        backend:
          service:
            name: ingress-name-oauth
            port:
              number: 4180
        pathType: Prefix
```

Všimněte si, že `hosts` a `secretName` jsou stejné jako v původním ingressu.
Jediné, co je třeba změnit v souboru, jsou všechny výskyty
`ingress-name` a `hostname`, nahraďte je názvem vašeho ingressu
a URL webové stránky a aplikujte soubor.

Se všemi provedenými změnami je vaše webová stránka nyní zabezpečena službou
SSO e-infra.
