# MinIO Operator

[MinIO Operator](https://min.io/docs/minio/kubernetes/upstream/index.html) poskytuje snadné spuštění MinIO Tenanta na Kubernetes. Poskytli jsme clusterový MinIO Operator pro snadné nasazení serverů pro objektové úložiště MinIO S3. MinIO Operator definuje typ `Tenant`, který zajišťuje existenci objektového úložiště. Kompletní dokumentace o jeho struktuře je k dispozici [zde](https://min.io/docs/minio/kubernetes/upstream/index.html). Oficiální manuál pro vytvoření příkladu MinIO tenanta lze nalézt [zde](https://github.com/minio/operator/blob/master/docs/examples.md). Pro vaše pohodlí poskytujeme níže několik funkčních příkladů, rozdělených do sekcí.

## Nasazení jediné instance

Můžete začít s příkladem instance, která je vhodná pro testování. Tento příklad vytváří zdroj Tenant definovaný nainstalovaným MinIO operátorem. Příklad můžete stáhnout [zde](/examples/ceritsc/manifests/minio-minimal-tenant.yaml).

```yaml
apiVersion: minio.min.io/v2
kind: Tenant
metadata:
  name: myminio
spec:
  ## Create users in the Tenant using this field. Make sure to create secrets per user added here.
  ## Secret should follow the format used in `minio-creds-secret`.
  users:
    - name: myminio-user-secret
  ## Specification for MinIO Pool(s) in this Tenant.
  pools:
    ## Servers specifies the number of MinIO Tenant Pods / Servers in this pool.
    ## For standalone mode, supply 1. For distributed mode, supply 4 or more.
    ## Note that the operator does not support upgrading from standalone to distributed mode.
    - servers: 4
      ## custom pool name
      name: pool-0
      ## volumesPerServer specifies the number of volumes attached per MinIO Tenant Pod / Server.
      volumesPerServer: 2
      ## This VolumeClaimTemplate is used across all the volumes provisioned for MinIO Tenant in this Pool.
      volumeClaimTemplate:
        metadata:
          name: data
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 2Gi
      ## Configure Pod's security context
      securityContext:
        runAsNonRoot: true
        fsGroup: 1000
        runAsUser: 1000
        runAsGroup: 1000
      ## Configure container security context
      containerSecurityContext:
        runAsNonRoot: true
        privileged: false
        runAsUser: 1000
        runAsGroup: 1000
        allowPrivilegeEscalation: false
        capabilities:
          drop:
          - ALL
        seccompProfile:
          type: "RuntimeDefault"
```

Tento příklad také vyžaduje nasazení tajného klíče pro uživatele. Můžete stáhnout [příklad tajného klíče](/examples/ceritsc/manifests/minio-minimal-tenant-secret.yaml).
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: myminio-user-secret
type: Opaque
data:
  CONSOLE_ACCESS_KEY: Y29uc29sZQ== # "console", base64 encoding
  CONSOLE_SECRET_KEY: Y29uc29sZTEyMw== # "console123", base64 encoding
```
Pro specifikaci a zakódování/odkódování vlastního `access_key` (*uživatelské jméno*) a `secret_key` (*heslo*) můžete použít následující příkazy:
```bash
# encode
echo -n "securepassword" | base64
# decode
echo -n "c2VjdXJlcGFzc3dvcmQ=" | base64 -d
```

Spusťte `kubectl create -n [namespace] -f example-tenant-secret.yaml -f example-tenant.yaml`, měli byste vidět pod s názvem `myminio-pool-0-0` (možná podobné pody v závislosti na konfiguraci) běžící ve specifikovaném namespace.

## Přístup k úložišti S3

Pro přístup k úložišti z jiných Podů můžete použít služby `myminio-console` a `myminio-hl`, které jsou automaticky vytvořeny. Tyto služby fungují jako DNS názvy, takže je můžete použít jako koncové body pro další aplikace v rámci Kubernetes clusteru. Pokud je vyžadován přístup do jiného namespace, použijte celé jméno - např. `myminio-hl.[namespace].svc.cluster.local`.

- `myminio-console:9443` poskytuje HTTP webovou konzoli pro správu MinIO
- `myminio-hl:9000` poskytuje připojení k S3 serveru

## Síťová politika

Pro zvýšení bezpečnosti lze použít *síťovou politiku*, která umožňuje síťový přístup k úložišti S3 pouze z určitých podů. Více informací naleznete v [Síťové politice](../kubernetes/security). Externí přístup, tj. přístup z veřejného internetu, je ve výchozím nastavení zakázán. Je však možné vystavit S3 prostřednictvím [Load Balancer](../kubernetes/expose#other-applications).

Toto je příklad NetworkPolicy aplikované na MinIO tenant. Tento příklad můžete stáhnout [zde](/examples/ceritsc/manifests/minio-minimal-tenant-np.yaml)
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: myminio-np
spec:
  podSelector:
    matchLabels:
      # This NetworkPolicy is applied to the `myminio` Tenant
      app: myminio
  policyTypes:
  - Egress
  - Ingress
  egress:
    # Enables egress communication to the local DNS resolver
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
    # Enables egress communication to the Minio operator installed in Kubernetes.
  - to:
    - ipBlock:
        cidr: 10.43.0.1/32
    - ipBlock:
        cidr: 10.16.62.14/32
    - ipBlock:
        cidr: 10.16.62.15/32
    - ipBlock:
        cidr: 10.16.62.16/32
    - ipBlock:
        cidr: 10.16.62.17/32
    - ipBlock:
        cidr: 10.16.62.18/32
    ports:
    - port: 6443
      protocol: TCP
  ingress:
    # Enables ingress communication from any Pod to the 9000 and 9443 ports
    # for web management console access and S3 connection
  - from:
    - podSelector: {}
    ports:
    - protocol: TCP
      port: 9000
    - protocol: TCP
      port: 9443
```

Toto je příklad NetworkPolicy aplikované na hypotetickou aplikaci. Tento příklad můžete stáhnout [zde](/examples/ceritsc/manifests/minio-minimal-application-np.yaml)
```yaml
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: myapplication-allow-s3
spec:
  podSelector:
    matchLabels:
      # This NetworkPolicy is applied to `myapplication` Pod
      app: myapplication
  policyTypes:
  - Egress
  egress:
    # Enables egress S3 communication from `myapplication` to the `myminio` Tenant
  - to:
    - podSelector:
        matchLabels:
          app : myminio
    ports:
    - protocol: TCP
      port: 9000
```
