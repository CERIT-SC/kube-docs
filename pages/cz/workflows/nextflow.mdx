# Spu≈°tƒõn√≠ Nextflow Pipelines v Kubernetes

N√°sleduj√≠c√≠ text popisuje, jak spustit [Nextflow](https://nextflow.io) pipeline v Kubernetes clusteru CERIT-SC.

Mus√≠te nainstalovat Nextflow na sv√©m m√≠stn√≠m poƒç√≠taƒçi nebo na jak√©mkoli poƒç√≠taƒçi, ze kter√©ho spust√≠te Nextflow; pipeline se na tomto poƒç√≠taƒçi nespust√≠, pobƒõ≈æ√≠ v Kubernetes clusteru a poƒç√≠taƒç slou≈æ√≠ pouze k jej√≠mu spu≈°tƒõn√≠. Poƒç√≠taƒç nemus√≠ b√Ωt online, zat√≠mco pipeline st√°le bƒõ≈æ√≠.

## Instalace Nextflow

Pro instalaci Nextflow zadejte tento p≈ô√≠kaz ve sv√©m termin√°lu:

```shell
curl -s https://get.nextflow.io | bash
```
M≈Ø≈æete nainstalovat konkr√©tn√≠ verzi Nextflow exportov√°n√≠m promƒõnn√© prost≈ôed√≠ `NXF_VER` p≈ôed spu≈°tƒõn√≠m instalaƒçn√≠ho p≈ô√≠kazu, nap≈ô.:

```shell
export NXF_VER=24.04.4
curl -s https://get.nextflow.io | bash
```

V souƒçasnosti je 24.04.4 nejvy≈°≈°√≠ dostupn√° verze pomoc√≠ t√©to metody. M≈Ø≈æete si v≈°ak tak√© st√°hnout nejnovƒõj≈°√≠ verzi z githubu:
`https://github.com/nextflow-io/nextflow`, kterou lze nainstalovat n√°sleduj√≠c√≠m zp≈Øsobem:

```shell
git clone https://github.com/nextflow-io/nextflow.git
cd nextflow
git checkout v24.04.4
make compile install
```

## Architektura Nextflow 

Nextflow pipeline se spou≈°t√≠ pomoc√≠ p≈ô√≠kazu `nextflow`, nap≈ô.:

```shell
nextflow run hello
```

co≈æ spust√≠ pipeline `hello`. Spu≈°tƒõn√≠ pipeline se skl√°d√° ze dvou ƒç√°st√≠:
*≈ô√≠d√≠c√≠ho modulu workflow* a *pracovn√≠k≈Ø*. *≈ò√≠d√≠c√≠ modul workflow* spravuje
bƒõh pipeline, zat√≠mco *pracovn√≠ci* vykon√°vaj√≠ jednotliv√© √∫koly. 

Nextflow engine oƒçek√°v√°, ≈æe *≈ô√≠d√≠c√≠ modul workflow* a *pracovn√≠ci* maj√≠
p≈ô√≠stup k nƒõjak√©mu sd√≠len√©mu √∫lo≈æi≈°ti. Na m√≠stn√≠m poƒç√≠taƒçi je to obvykle jen
konkr√©tn√≠ adres√°≈ô, v p≈ô√≠padƒõ distribuovan√©ho v√Ωpoƒçtu to mus√≠ b√Ωt
s√≠≈•ov√© √∫lo≈æi≈°tƒõ, jako je NFS mount. U≈æivatel mus√≠ specifikovat, jak√© √∫lo≈æi≈°tƒõ m≈Ø≈æe b√Ωt
pou≈æito p≈ôi spu≈°tƒõn√≠ Nextflow.

## Spu≈°tƒõn√≠ Nextflow v Kubernetes

V p≈ô√≠padƒõ K8s je *≈ô√≠d√≠c√≠ modul workflow* spu≈°tƒõn jako
[Pod](https://kubernetes.io/docs/concepts/workloads/pods/) v Kubernetes
clusteru. Jeho √∫kolem je spou≈°tƒõt *pracovn√≠* pod podle definice pipeline.
Pod *≈ô√≠d√≠c√≠ho modulu workflow* m√° nƒõjak√© vygenerovan√© jm√©no jako `naughty-williams`.
*Pracovn√≠ci* maj√≠ hashovan√© n√°zvy jako `nf-81dae79db8e5e2c7a7c3ad5f6c7d59c6`.

Nejprve mus√≠te m√≠t:
- nainstalovan√Ω [`kubectl`](../kubernetes/kubectl) s `kubeconfig` souborem na oƒçek√°van√©m m√≠stƒõ `$HOME/.kube/config`. 
- Kubernetes [Namespace](https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/) pro spu≈°tƒõn√≠ (viz [zde](../kubernetes/ns), jak zjistit sv≈Øj namespace).
- vytvo≈ôen√Ω [PVC](https://kubernetes.io/docs/concepts/storage/persistent-volumes/) (viz [zde](../kubernetes/pvc), jak to udƒõlat).

### Konfigurace üß©

Spu≈°tƒõn√≠ Nextflow pipeline v Kubernetes vy≈æaduje m√≠stn√≠ konfiguraci s nƒõkter√Ωm nezbytn√Ωm obsahem:

```js filename="nextflow.config" copy
k8s {
   namespace = '[your_namespace]'
   runAsUser = 1000
   computeResourceType = 'Job'
   storageClaimName = '[name_of_created_pvc]'
   storageMountPath = '[mountpath]'
   launchDir = '[mountpath_from_storageMountPath]/[some_launchDir_path]'
   workDir = '[mountpath_from_storageMountPath]/[some_workDir_path]'
}

executor {
  queueSize = 30
}

process {
   executor = 'k8s'
   pod = [[securityContext:[fsGroupChangePolicy:'OnRootMismatch', runAsUser:1000, runAsGroup:1, fsGroup:1]], [automountServiceAccountToken:false]]
}
```

Mus√≠te nastavit `namespace` na spr√°vnou hodnotu (namespace, ke kter√© m√°te p≈ô√≠stup). Nastavte n√°zev PVC, kter√© jste vytvo≈ôili, jako `storageClaimName`, bude slou≈æit jako sd√≠len√Ω pracovn√≠ prostor pro Nextflow. Nastavte `storageMountPath` na jakoukoli cestu, kde byste chtƒõli p≈ôipojit tento PVC (doporuƒçujeme `/mnt`). Nastavte `launchDir` a `workDir`, aby ukazovaly nƒõkam na PVC. Dbejte na to, pokud spou≈°t√≠te Nextflow paralelnƒõ, v≈ædy pou≈æ√≠vejte r≈Øzn√© `launchDir` a `workDir` pro paraleln√≠ bƒõhy.

Existuje spousta dal≈°√≠ch mo≈ænost√≠ p≈ôizp≈Øsoben√≠ pro pracovn√≠ky nebo jednotliv√© procesy. Je mo≈æn√©:
- p≈ôipojit dal≈°√≠ PVC nebo tajemstv√≠
- nastavit po≈æadavky na zdroje (cpu, pamƒõ≈•)
- p≈ôidat ≈°t√≠tky nebo anotace
- atd.

Pro p≈ôizp≈Øsoben√≠ jednotliv√Ωch proces≈Ø (nap≈ô. pamƒõ≈•, cpu) viz sekce dokumentace Nextflow o [procesech](https://www.nextflow.io/docs/latest/process.html). Pro p≈ôizp≈Øsoben√≠ samotn√©ho podu (nap≈ô. p≈ôipojen√≠ pvc) viz podrobnosti v [dokumentaci podu nextflow](https://www.nextflow.io/docs/latest/process.html#pod). 

P≈ôi m√≠ch√°n√≠ generick√© konfigurace procesu 

```js
process {...}
```

a selektor≈Ø se uplat≈àuj√≠ n√°sleduj√≠c√≠ pravidla priority (od ni≈æ≈°√≠ k vy≈°≈°√≠):

- Gener√°ln√≠ konfigurace procesu (`nextflow.config`).
- Specifick√° direktiva procesu definovan√° ve skriptu workflow.
- definice selektoru withLabel.
- definice selektoru withName.

### Spu≈°tƒõn√≠ ‚è±

Pro spu≈°tƒõn√≠ pipeline mus√≠te pou≈æ√≠t pod≈ô√≠zen√Ω p≈ô√≠kaz `kuberun` p≈ô√≠kazu `nextflow`. Pokud pou≈æ√≠v√°te verzi `nextflow` 22.06.1 nebo novƒõj≈°√≠, mus√≠te p≈ôidat mo≈ænosti 

```shell
-head-image 'cerit.io/nextflow/nextflow:24.04.4' -head-memory 4096Mi -head-cpus 1
```

Tyto mo≈ænosti jsou vy≈æadov√°ny pouze pro *pod ≈ô√≠d√≠c√≠ho modulu workflow* v na≈°em clusteru. `head-memory`/`head-cpus` specifikuj√≠ mno≈æstv√≠ pamƒõti/cpu vyhrazen√© pro pod ≈ô√≠d√≠c√≠ho modulu -- pou≈æijte vy≈°≈°√≠ ƒç√≠slo, pokud se oƒçek√°v√°, ≈æe va≈°e pipeline vygeneruje tis√≠ce √∫kol≈Ø.

P≈ô√≠klad p≈ô√≠kazu pro spu≈°tƒõn√≠:

```shell
nextflow kuberun hello -head-image 'cerit.io/nextflow/nextflow:24.04.4' -head-memory 4096Mi -head-cpus 1 -v PVC:/mnt 
```

Pokud pou≈æ√≠v√°te verzi `nextflow` ni≈æ≈°√≠ ne≈æ 22.06.1 nebo dostanete chybovou zpr√°vu informuj√≠c√≠ o `head-image not known`, mus√≠te p≈ôidat mo≈ænost

```shell
-pod-image 'cerit.io/nextflow/nextflow:22.06.1' 
```

P≈ô√≠klad p≈ô√≠kazu pro spu≈°tƒõn√≠:

```bash
nextflow kuberun hello -pod-image 'cerit.io/nextflow/nextflow:22.06.1'
```

Konfiguraƒçn√≠ soubor m≈Ø≈æe vypadat n√°sledovnƒõ:

```js filename="nextflow.config" copy
k8s {
   namespace = 'nf-ns'
   runAsUser = 1000
   computeResourceType = 'Job'
   storageClaimName = 'pvc-nf'
   storageMountPath = '/mnt'
   launchDir = '/mnt/data1'
   workDir = '/mnt/data1/tmp'
}

executor {
  queueSize = 30
}

process {
   executor = 'k8s'
   memory = '500M' // THIS WILL BE DEFAULTLY APPLIED TO ALL WORKERS IF NOT SPECIFIED IN WORKFLOW SCRIPT
   pod = [[label: 'hpctransfer', value: 'must'], [securityContext:[fsGroupChangePolicy:'OnRootMismatch', runAsUser:1000, runAsGroup:1, fsGroup:1]], [automountServiceAccountToken:false], [secret: 'keythings', mountPath: '/etc/secrets']] // THIS WILL BE APPLIED TO ALL WORKERS
   
   withLabel:VEP { // THIS WILL BE APPLIED ONLY TO PROCESS WITH LABEL VEP EVEN IF SPECIFIED IN WORKFLOW SCRIPT
       memory = {check_resource(14.GB * task.attempt)}
   }
   
}

process mdrun { // THIS WILL BE APPLIED ONLY TO PROCESS NAMED mdrun IF NOT SPECIFIED IN WORKFLOW SCRIPT
  cpus 20
}
```

### Debug üêû 
Doporuƒçujeme sledovat sv≈Øj namespace v GUI Rancher nebo v p≈ô√≠kazov√©m ≈ô√°dku, kdy≈æ odes√≠l√°te pipeline. Ne v≈°echny probl√©my se propaguj√≠ do termin√°lu, zejm√©na chyby souvisej√≠c√≠ s Kubernetes, jako je p≈ôekroƒçen√≠ kv√≥ty. M≈Ø≈æete otev≈ô√≠t z√°lo≈æku `Jobs` v GUI Rancher a d√°vat pozor na √∫lohy, kter√© jsou `In progress` p≈ô√≠li≈° dlouho nebo ve stavu `Error`. U≈æiteƒçn√© p≈ô√≠kazy mohou zahrnovat 

```shell
kubectl get jobs -n [namespace] // GET ALL JOBS IN NAMESPACE
kubectl describe job [job_name] -n [namespace] // FIND OUT MORE ABOUT JOB AND WHAT IS HAPPENING WITH IT

kubectl get pods -n [namespace] // GET ALL PODS IN NAMESPACE
kubectl describe pod [pod_name] -n [namespace] // FIND OUT MORE ABOUT POD AND WHAT IS HAPPENING WITH IT
kubectl logs [pod_name] -n [namespace] // GET POD LOGS (IF AVAILABLE)
```

Pokud √∫loha ƒçek√° na spu≈°tƒõn√≠ p≈ô√≠li≈° dlouho, zkuste popsat √∫lohu. M≈Ø≈æe to odhalit p≈ôekroƒçen√≠ kv√≥ty ve va≈°em namespace:

```
  Warning  FailedCreate  18m    job-controller  Error creating: pods "nf-5dd9dc33d33c729b5cd57c818bafba86-lk4tl" is forbidden: exceeded quota: default-kbz9v, requested: requests.cpu=8, used: requests.cpu=16, limited: requests.cpu=20
```

Pokud se v√°m to stane, zva≈æte sn√≠≈æen√≠ problematick√Ωch po≈æadavk≈Ø na zdroje kontroleru pracovn√≠ho postupu nebo proces≈Ø, kter√© mohou vy≈æadovat p≈ô√≠li≈° mnoho. Pokud nev√≠te, co dƒõlat, <a href="mailto:k8s@ics.muni.cz">kontaktujte n√°s</a> a spoleƒçnƒõ najdeme ≈ôe≈°en√≠.

## Spu≈°tƒõn√≠ Nextflow Hello pipeline

St√°hnƒõte [nextflow.config](deployments/nextflow.config), kter√Ω je p≈ôipraven k pou≈æit√≠, staƒç√≠ zmƒõnit `namespace` na spr√°vnou hodnotu (namespace, ke kter√©mu m√°te p≈ô√≠stup) a specifikovat `launchDir` a `workDir`, aby ukazovaly nƒõkam na PVC. D√°vejte pozor, pokud spou≈°t√≠te Nextflow paralelnƒõ, v≈ædy pou≈æ√≠vejte r≈Øzn√© `launchDir` a `workDir` pro paraleln√≠ bƒõhy.

Mus√≠te soubor uchov√°vat v aktu√°ln√≠m adres√°≈ôi, kde je spu≈°tƒõn p≈ô√≠kaz `nextflow`, a mus√≠ b√Ωt pojmenov√°n `nextflow.config`.

Aby Nextflow spustil pipeline `hello` v Kubernetes, spus≈•te n√°sleduj√≠c√≠ p≈ô√≠kaz:

```shell
nextflow kuberun hello -pod-image 'cerit.io/nextflow/nextflow:22.06.1' -v PVC:/mnt 
```

kde PVC je n√°zev PVC, jak bylo uvedeno v√Ω≈°e. Bude p≈ôipojeno jako /mnt.
Tento bod p≈ôipojen√≠ byste mƒõli pou≈æ√≠vat, proto≈æe nƒõkter√© pipeline oƒçek√°vaj√≠ tuto lokaci.

Pokud pou≈æ√≠v√°te verzi `nextflow` 22.06.1 nebo novƒõj≈°√≠, jak bylo uvedeno v√Ω≈°e, pou≈æijte m√≠sto toho:

```shell
nextflow kuberun hello -pod-image 'cerit.io/nextflow/nextflow:22.06.1' -head-memory 4096Mi -head-cpus 1 -v PVC:/mnt 
```

Pokud bylo v≈°e spr√°vnƒõ, mƒõli byste vidƒõt v√Ωstup jako tento:

```
 Pod started: naughty-williams
 N E X T F L O W  ~  version 22.06.1-SNAPSHOT
 Launching `nextflow-io/hello` [naughty-williams] - revision: e6d9427e5b [master]
 [f0/ce818c] Submitted process > sayHello (2)
 [8a/8b278f] Submitted process > sayHello (1)
 [5f/a4395f] Submitted process > sayHello (3)
 [97/71a2e0] Submitted process > sayHello (4)
 Ciao world!
 Hola world!
 Bonjour world!
 Hello world!
```

### Upozornƒõn√≠

* Pokud pipeline bƒõ≈æ√≠ dlouho (co≈æ nen√≠ p≈ô√≠pad pipeline `hello`), p≈ô√≠kaz `nextflow` konƒç√≠ s ukonƒçen√≠m spojen√≠. To je norm√°ln√≠ a neznamen√° to, ≈æe pipeline ji≈æ nebƒõ≈æ√≠. P≈ôestane pouze logovat do va≈°eho termin√°lu. St√°le m≈Ø≈æete naj√≠t protokoly kontroleru pracovn√≠ho postupu v GUI Rancher.

* Bƒõh pipeline m≈Ø≈æe b√Ωt ukonƒçen z GUI Rancher, stisknut√≠ `ctrl-c` pipeline neukonƒç√≠.

* Protokol ladƒõn√≠ pipeline lze nal√©zt na PVC v `launchDir/.nextflow.log`. Po sobƒõ jdouc√≠ bƒõhy rotuj√≠ protokoly, aby nebyly p≈ôeps√°ny.

* Pokud pipeline sel≈æe, m≈Ø≈æete se pokusit obnovit pipeline pomoc√≠ p≈ô√≠kazov√© volby `-resume`, vytvo≈ô√≠ nov√Ω bƒõh, ale pokus√≠ se p≈ôeskoƒçit ji≈æ dokonƒçen√© √∫koly. Viz [podrobnosti](https://www.nextflow.io/blog/2019/demystifying-nextflow-resume.html).

* V≈°echny bƒõhy (√∫spƒõ≈°n√© nebo selhan√©) udr≈æuj√≠ *pod kontroleru pracovn√≠ho postupu* viditeln√Ω v GUI Rancher, selhan√© pracovn√≠ky jsou tak√© uchov√°v√°ny v GUI Rancher. M≈Ø≈æete je podle pot≈ôeby odstranit z GUI.

* U nƒõkter√Ωch *pracovn√≠k≈Ø* nejsou protokoly dostupn√© v GUI Rancher, ale protokoly lze sledovat pomoc√≠ p≈ô√≠kazu:

```shell
kubectl logs POD -n NAMESPACE 
```

  kde `POD` je n√°zev *pracovn√≠ka* (nap≈ô. `nf-81dae79db8e5e2c7a7c3ad5f6c7d59c6`) a `NAMESPACE` je pou≈æ√≠van√Ω namespace.

## nf-core/sarek pipeline

[nf-core/sarek](https://nf-co.re/sarek) je analytick√° pipeline pro detekci germin√°ln√≠ch nebo somatick√Ωch variant (p≈ôedzpracov√°n√≠, vol√°n√≠ variant a anotace) z WGS / c√≠len√©ho sekvenov√°n√≠.

### Spu≈°tƒõn√≠ v Kubernetes

Sarek vy≈æaduje specifick√Ω
[nextflow.config](/examples/ceritsc/nextflow/nextflow-sarek.config),
nastavuje v√≠ce pamƒõti pro proces VEP, kter√Ω je souƒç√°st√≠ pipeline. P≈ôi z√°kladn√≠ch nastaven√≠ch bude proces VEP pravdƒõpodobnƒõ zabit kv≈Øli pamƒõti.
Tak√© vy≈æaduje specifick√Ω
[custom.config](/examples/ceritsc/nextflow/custom.config)
proto≈æe git verze Sarek obsahuje chybu, tak≈æe v√Ωstupn√≠ statistiky budou zapisov√°ny do nespr√°vn√Ωch soubor≈Ø.

Pipeline Sarek pou≈æ√≠v√° funkce v konfiguraci pipeline. Nicm√©nƒõ,
funkce v konfiguraci pipeline moment√°lnƒõ nejsou podporov√°ny executor `kuberun`. 

Abychom se vypo≈ô√°dali s touto chybou, pot≈ôebujete verzi Nextflow 22.06.1-edge nebo novƒõj≈°√≠.

St√°hnƒõte
[nextflow-cfg.sh](/examples/ceritsc/nextflow/nextflow-cfg.sh)
a
[nextflow.config.add](/examples/ceritsc/nextflow/nextflow.config.add)
a um√≠stƒõte obƒõ na PVC (do jeho ko≈ôenov√©ho adres√°≈ôe). Nep≈ôejmenov√°vejte soubory a udƒõlejte `nextflow-cfg.sh` spustiteln√Ωm (`chmod a+x nextflow-cfg.sh`).

Nyn√≠, pokud jste p≈ôipravili sv√° data na PVC, m≈Ø≈æete spustit pipeline Sarek n√°sleduj√≠c√≠m p≈ô√≠kazem:

```shell
nextflow kuberun nf-core/sarek -head-memory 4096Mi -head-cpus 1 -head-prescript /mnt/nextflow-cfg.sh -pod-image 'cerit.io/nextflow/nextflow:22.06.1' -v PVC:/mnt --input /mnt/test.tsv --genome GRCh38 --tools HaplotypeCaller,VEP,Manta
```


kde `PVC` je zm√≠nƒõn√Ω PVC a `test.tsv` obsahuje vstupn√≠ data um√≠stƒõn√° na PVC.

### Upozornƒõn√≠

* Doporuƒçuje se st√°hnout *igenome* z um√≠stƒõn√≠ S3 Amazon na m√≠stn√≠ PVC. To rychle zrychl√≠ mo≈ænost `-resume` v p≈ô√≠padƒõ, ≈æe bƒõh pipeline sel≈æe a vy ji znovu spust√≠te, abyste pokraƒçovali. Tak√© to zm√≠r≈àuje p≈ôet√≠≈æen√≠ Amazonu nebo probl√©my s√≠tƒõ, kter√© vedou k selh√°n√≠ pipeline. Jakmile st√°hnete *igenome*, jednodu≈°e p≈ôidejte nƒõco jako `--igenomes_base /mnt/igenome` do p≈ô√≠kazov√Ωch mo≈ænost√≠ `nextflow`.

* Pokud obdr≈æ√≠te chybu o nezn√°m√©m `check_resource`, pak jste selhali s nastaven√≠m `nextflow-cfg.sh` a `nextflow.config.add`.

* Bƒõh pipeline konƒç√≠ stacktrace a chybou `No signature of method: java.lang.String.toBytes()`. To je norm√°ln√≠ a je to v√Ωsledek toho, ≈æe nebyla specifikov√°na e-mailov√° adresa pro odesl√°n√≠ koneƒçn√©ho e-mailu. Nen√≠ t≈ôeba se ob√°vat.

* Bƒõh pipeline neƒçist√≠ workDir, je na u≈æivateli, aby jej vyƒçistil/odstranil.

* Ruƒçn√≠ obnoven√≠ Sarek je mo≈æn√© pomoc√≠ r≈Øzn√Ωch specifikac√≠ `--input`. Viz [zde](https://nf-co.re/sarek/2.7.1/usage#troubleshooting).


## vib-singlecell-nf/vsn-pipelines pipeline

[vsn-pipelines](https://vsn-pipelines.readthedocs.io/en/latest/) obsahuj√≠ v√≠ce pracovn√≠ch postup≈Ø pro anal√Ωzu dat z jednoho bunƒõƒçn√©ho transkriptomu a z√°vis√≠ na ≈ôadƒõ n√°stroj≈Ø.

### Kubernetes Run

Mus√≠te st√°hnout specifick√Ω pipeline [nextflow.config](/examples/ceritsc/nextflow-vsn.config) a um√≠stit jej do aktu√°ln√≠ho adres√°≈ôe, odkud spou≈°t√≠te Nextflow. Tato pipeline pou≈æ√≠v√° parametr `-entry` k urƒçen√≠ vstupn√≠ho bodu pracovn√≠ho postupu. Pokud nen√≠ vy≈ôe≈°ena [tato ot√°zka #2397](https://github.com/nextflow-io/nextflow/issues/2397), je pot≈ôeba opraven√° verze Nextflow. Abyste se vypo≈ô√°dali s touto chybou, pot≈ôebujete verzi Nextflow 22.06.1-edge nebo novƒõj≈°√≠.

Na PVC mus√≠te p≈ôipravit data do adres√°≈ô≈Ø specifikovan√Ωch v `nextflow.config`, pod√≠vejte se na v≈°echny v√Ωskyty `/mnt/data1` v konfiguraci a zmƒõ≈àte je podle pot≈ôeby.

Konzultujte [dokumentaci](https://vsn-pipelines.readthedocs.io/en/latest/index.html) pro dal≈°√≠ mo≈ænosti konfigurace.

Pipeline m≈Ø≈æete spustit n√°sleduj√≠c√≠m p≈ô√≠kazem:

```shell
nextflow -C nextflow.config kuberun vib-singlecell-nf/vsn-pipelines -pod-image 'cerit.io/nextflow/nextflow:22.06.1' -head-cpus 1 -head-memory 4096Mi -v PVC:/mnt -entry scenic
```

kde `PVC` je zm√≠nƒõn√Ω PVC, `scenic` je vstupn√≠ bod pipeline a `nextflow.config` je sta≈æen√Ω `nextflow.config`.

### Upozornƒõn√≠

* Pro paraleln√≠ bƒõh mus√≠te nastavit `maxForks` v `nextflow.config` spolu s parametrem `params.sc.scenic.numRuns`. Konzultujte [dokumentaci](https://vsn-pipelines-examples.readthedocs.io/en/latest/PBMC10k_multiruns.html).

* Promƒõnn√° `NUMBA_CACHE_DIR`, kter√° ukazuje na `/tmp` nebo jin√Ω zapisovateln√Ω adres√°≈ô, je po≈æadavek, jinak se prov√°dƒõn√≠ nezda≈ô√≠ z d≈Øvodu zam√≠tnut√≠ opr√°vnƒõn√≠. Sna≈æ√≠ se aktualizovat pouze pro ƒçten√≠ ƒç√°sti bƒõ≈æ√≠c√≠ho kontejneru.

## Pou≈æit√≠ GPU

Pou≈æit√≠ GPU v kontejnerech je jednoduch√©, staƒç√≠ p≈ôidat:

```
  accelerator = 1
```

do sekce procesu `nextflow.config`, nap≈ô.:

```js filename="nextflow.config" copy
process {
   executor = 'k8s'

   withLabel:VEP {
      accelerator = 1
   }
}
```
