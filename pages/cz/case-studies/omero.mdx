# Spuštění aplikace Omero

Máme úkol spustit aplikaci [Omero](https://www.openmicroscopy.org/omero/) v Kubernetes. V podstatě potřebujeme dvě věci: Docker kontejner aplikace a manifest nasazení. Aplikace může mít nějaké závislosti, jako je databáze, v tomto případě je také musíme nasadit.

Při hledání termínu `omero docker` jsme našli výsledek [https://github.com/ome/omero-server-docker](https://github.com/ome/omero-server-docker), který vysvětluje, jak nasadit server Omero. Má dvě možnosti:
 
1. Spuštění OMERO pomocí docker-compose
2. Spuštění obrazů (manuálně)

Pro Kubernetes musíme zvolit druhou možnost, protože docker-compose nelze přímo aplikovat na Kubernetes.

Druhá možnost začíná databází a zdá se, že se jedná o databázi Postgres. Zde máme štěstí, protože Kubernetes poskytuje operátor Postgres pro snadné nasazení databáze, viz naši dokumentaci [Operators](../operators/postgres-cnpg).

Ve všech níže uvedených příkazech nahraďte `[namespace]` názvem vašeho vlastního prostoru.

## Postgres

Operátor Postgres vytváří náhodná hesla ve výchozím nastavení, ale v tomto příkladu vytvoříme explicitní heslo pro databázi Postgres. Použijeme `omero` jako uživatelské jméno databáze a nějaké tajné heslo, např. `xxxpassword`. Nejprve musíme vytvořit tajemství s názvem a heslem. Obě musí být [base64](https://www.base64encode.org/) zakódována. 
Můžete použít odkaz nebo použít `echo -e 'omero' | base64` v Linuxovém shellu. Přepínač `-n` je zásadní, řetězec (název, heslo) nesmí obsahovat znak nového řádku (`\n`). Jakmile máme dvě hodnoty zakódované v base64, vytvoříme a nasadíme tajemství:

```yaml
apiVersion: v1
data:
  password: b21lcm9rb2tvcw==
  username: b21lcm8=
kind: Secret
metadata:
  name: omero-db-app
type: kubernetes.io/basic-auth
```

`metadata.name` může být libovolné, ale bude odkazováno v následujících manifestech. [Link](/examples/ceritsc/manifests/db-app-secret.yaml).

```shell
kubectl create -f db-app-secret.yaml -n [namespace]
```

Jakmile máme tajemství, nasadíme databázi. Jednoduchá konfigurace je dostatečná.

```yaml
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: omero
spec:
  instances: 1
  imageName: 'ghcr.io/cloudnative-pg/postgresql:15.3-2'
  primaryUpdateStrategy: unsupervised
  bootstrap:
    initdb:
      database: omero
      owner: omero
      secret:
        name: omero-db-app
  resources:
    requests:
      memory: 2Gi
      cpu: 100m
    limits:
      memory: 6Gi
      cpu: 2
  storage:
    size: 10Gi
    storageClass: zfs-csi
```

Tento manifest odkazuje na název tajemství v `spec.bootstrap.initdb.secret.name`, musí odpovídat názvu tajemství, které jsme vytvořili. Pokud je databáze pomalá při zpracování veškeré zátěže, může být zvýšena `spec.resources.limits.cpu`. Pro ne-demo účely by měla být `spec.resources.requests.cpu` zvýšena, aby odpovídala skutečné typické zátěži. [Link](/examples/ceritsc/manifests/db-cluster.yaml).

```shell
kubectl create -f db-cluster.yaml -n [namespace]
```

Po chvíli by měl být vytvořen nový Pod v prostoru `[namespace]`. Bude pojmenován `omero-1`. 

Vytvořený cluster má pouze jeden Pod, není to skutečný a odolný cluster. Pro vysoce dostupné clustery viz [Postgres Operator](../operators/postgres-cnpg).

## Omero Server

Spuštění `omero-server` bylo druhým krokem. Stránka ukazuje, jak jej spustit v Dockeru:

```shell
docker run -d --name omero-server --link postgres:db \
    -e CONFIG_omero_db_user=postgres \
    -e CONFIG_omero_db_pass=postgres \
    -e CONFIG_omero_db_name=postgres \
    -e ROOTPASS=omero-root-password \
    -p 4063:4063 -p 4064:4064 \
    openmicroscopy/omero-server
```

Aplikace v spravovaném Kubernetes nemůže běžet jako root. Je dobré získat očekávané uživatelské ID z kontejneru pomocí dockeru. Takže na stroji s nainstalovaným dockerem zadejte:

```shell
docker run -it --rm --entrypoint /bin/bash openmicroscopy/omero-server
```

To vytvoří a spustí kontejner docker serveru Omero. Dále zadejte příkaz `id`, zobrazí očekávané uživatelské ID a skupinové ID. Mělo by to vypadat takto:

```shell
xhejtman@osiris:~$ docker run -it --rm --entrypoint /bin/bash openmicroscopy/omero-server
bash-4.2$ id
uid=1000(omero-server) gid=997(omero-server) groups=997(omero-server)
bash-4.2$
```

Takže pro nasazení serveru použijeme uživatelské ID `1000` a skupinové ID `997`. 

Vidíme, že bychom měli předat čtyři proměnné prostředí: `CONFIG_omero_db_user`, ` CONFIG_omero_db_pass`, `CONFIG_omero_db_name` a `ROOTPASS`. Musíme předat další proměnnou `CONFIG_omero_db_host`, abychom specifikovali hostname databáze. Vytvořená databáze má hostname ve formátu `[name]-rw`, takže v našem případě `omero-rw`.

Použijeme tajemství databáze k vyplnění proměnných `CONFIG_omero_db_user` a `CONFIG_omero_db_pass`. Specifická část manifestu vypadá takto:

```yaml
name: CONFIG_omero_db_user
valueFrom:
  secretKeyRef:
    name: omero-db-app
    key: username
```

kde `name: omero-db-app` je název tajemství a `key: username` je klíč v tajemství.

Při procházení dolů na stránce githubu vidíme, že budeme také potřebovat nějaké trvalé úložiště:
* `/opt/omero/server/OMERO.server/var`: adresář var OMERO.server, včetně protokolů
* `/OMERO`: adresář dat OMERO

Použijeme netrvalý objem `emptyDir` pro protokoly a trvalý objem pro adresář `/OMERO`. Toto řešení vychází z předpokladu, že `/OMERO` obsahuje cenná data, zatímco `/opt/omero/server/OMERO.server/var` ne.

Pro trvalý objem musí být vytvořen PVC pomocí následujícího manifestu:

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-omero-data
spec:
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 100Gi
  storageClassName: nfs-csi
```

[Link](/examples/ceritsc/manifests/pvc-data.yaml).

```shell
kubectl create -f pvc-data.yaml -n [namespace]
```

Nakonec jsme připraveni nasadit `omero-server` pomocí [úplného manifestu](/examples/ceritsc/manifests/omero-server.yaml). Také vystavuje dva porty stejným způsobem jako příkaz Docker. **Nezapomeňte nastavit své vlastní ROOT heslo v následujícím fragmentu.** Také by měl být použit objekt Secret k předání hesla.

```yaml
name: ROOTPASS
value: omero-root-password
```

```shell
kubectl create -f omero-server.yaml -n [namespace]
```

Nyní bychom měli mít spuštěný `omero-server`. Aby byl přístupný z clusteru, je potřeba nasadit další manifest---službu.

```yaml
apiVersion: v1
kind: Service
metadata:
  name: omero-server
spec:
  type: ClusterIP
  ports:
  - port: 4064
    name: ssl
    targetPort: 4064
  - port: 4063
    name: plain
    targetPort: 4063
  selector:
    app: omero-server
```

[Odkaz](/examples/ceritsc/manifests/omero-server-svc.yaml).

```shell
kubectl create -f omero-server-svc.yaml -n [namespace]
```

Tento manifest zajišťuje, že `omero-server` je přístupný pomocí názvu `omero-server` (to je hodnota `metadata.name`). Porty v této službě musí odpovídat portům z Docker příkazu `-p 4063:4063 -p 4064:4064`. Název může být libovolný, ale bude se lišit pro každý port.

## Omero WEB

Spuštění `omero-server` nestačí, neposkytuje webové rozhraní. Po nějakém hledání můžeme následovat popis [omero-web](https://hub.docker.com/r/openmicroscopy/omero-web).

Docker příkaz je:

```shell
docker run -d --name omero-web \
    -e OMEROHOST=omero.example.org \
    -p 4080:4080 \
    openmicroscopy/omero-web-standalone
```

Samozřejmě nahradíme `OMERHOST` za `omero-server`, což odkazuje na naši službu z `omero-server`. Použitím stejných kroků jako pro `omero-server` získáme očekávané uživatelské ID a uživatelskou skupinu:

```shell
xhejtman@osiris:~$ docker run -it --rm --entrypoint /bin/bash openmicroscopy/omero-web-standalone
bash-4.2$ id
uid=999(omero-web) gid=998(omero-web) groups=998(omero-web)
bash-4.2$
```

Podobně jako u `omero-server`, webová stránka uvádí datový objem: 

* `/opt/omero/web/OMERO.web/var`: adresář `var` OMERO.web, včetně logů

Pro demonstrační účely je typ objemu `emptyDir` dostatečný. 

Nyní jsme schopni nasadit `omero-web` [manifest](/examples/ceritsc/manifests/omero-web.yaml).

```shell
kubectl create -f omero-web.yaml -n [namespace]
```

`omero-web` by nyní měl běžet. Abychom k němu měli přístup z internetu, potřebujeme službu a Ingress -- protože se jedná o webovou aplikaci. Služba je jednoduchá a umožňuje port z Docker příkazu `-p 4080:4080`:

```yaml
apiVersion: v1
kind: Service
metadata:
  name: omero-web
spec:
  type: ClusterIP
  ports:
  - port: 4080
    name: web
    targetPort: 4080
  selector:
    app: omero-web
```

[Odkaz](/examples/ceritsc/manifests/omero-web-svc.yaml).

```shell
kubectl create -f omero-svc.yaml -n [namespace]
```

A nakonec Ingress:

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: omero
  annotations:
    kubernetes.io/tls-acme: "true"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
  ingressClassName: nginx
  tls:
   - hosts:
       - "[omero-test].dyn.cloud.e-infra.cz"
     secretName: [omero-test]-dyn-cloud-e-infra-cz
  rules:
  - host: [omero-test].dyn.cloud.e-infra.cz
    http:
      paths:
        - pathType: Prefix
          path: "/"
          backend:
            service:
              name: omero-web
              port:
                number: 4080
```

[Odkaz](/examples/ceritsc/manifests/omero-web-ingress.yaml).

Nahraďte `[omero-test]` svým vlastním názvem. Celkový název hostitele nesmí překročit 63 znaků. Číslo portu (`4080`) musí odpovídat číslu portu služby.

```shell
kubectl create -f omero-web-ingress.yaml -n [namespace]
```

Můžete vidět běžící Pod `cm-acme-http-solver-`, v tomto případě počkejte, až bude hotový, pak můžete otevřít svůj Omero odkaz v prohlížeči. Přihlaste se pomocí uživatelského jména `root` a hesla z nasazení `omero-server` (hodnota): 

```yaml
- name: ROOTPASS
  value: omero-root-password
```

Nyní jsme hotovi!

