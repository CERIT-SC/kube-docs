# Projekty, Namespace a Kvóty

Naše kontejnerová platforma používá kvóty na *Projekty* a *Namespace*. Kvóta je omezení, kolik zdrojů může uživatel nebo skupina uživatelů využívat. Kubernetes používá dva druhy kvót zdrojů: *požadavky* a *limity*. Další informace o tomto konceptu naleznete v [dokumentaci Kubernetes](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/). Aktuálně aplikované kvóty jsou na zdroje *CPU* a *Paměť*. Tyto kvóty jsou nastaveny jak na *Projekt*, tak na *Namespace*.

*Osobní* projekt a výchozí *Namespace* mají 20 CPU *požadavek*, 32 CPU *limit*, 40 GB paměti *požadavky* a 64 GB paměti *limity*. Ostatní typy kvót nejsou nastaveny. Uživatel může požádat o nový projekt s výrazně většími kvótami na <a href="mailto:k8s@ics.muni.cz">IT Service desk</a>.

## Namespace

Bez žádosti o explicitní projekt je uživateli přidělen *Osobní* projekt s výše uvedenými limity. Spolu s *Osobním* projektem je vytvořen výchozí *Namespace*. Jak *Osobní* projekt, tak výchozí *Namespace* mají uvedené kvóty. Výchozí *Namespace* je nastaven na přesnou kvótu jako *Osobní* projekt, což znamená, že **jakýkoli nový** *Namespace* je mimo dostupné kvóty. Není možné rozšířit kvóty *Osobního* projektu, takže zde jsou dvě možnosti:

1. Požádat o explicitní projekt.
2. Snížit kvóty pro výchozí *Namespaces* a poskytnout uvolněné zdroje novému *Namespace*.

### Změna kvót Namespace

Chcete-li změnit kvóty zdrojů pro existující namespace, přejděte na `Cluster` (1), `Projects/Namespaces` (2), vyberte kontextové menu `Namespace` (3) a `Edit Config`.

![quotaedit1](/img/ceritsc/quotaedit1.png)

Poté můžete změnit `Resource Quotas` pro *Namespace* podle potřeby a `Save` je.

![quotaedit2](/img/ceritsc/quotaedit2.png)

### Vytváření nových Namespace

Aby vše fungovalo správně, nevytvářejte *Namespace* pomocí `kubectl` nebo `helm` nebo jiných nástrojů. Je to možné, ale tento *Namespace* neuvidíte v uživatelském rozhraní Rancher. Místo toho použijte uživatelské rozhraní Rancher k vytvoření *Namespace*. Většina nástrojů, jako je `helm`, `kustomize`, by měla s již existujícími *Namespaces* pracovat bez problémů.

1. Nejprve v projektu, kde chcete vytvořit nový namespace, snižte kvóty zdrojů některých z existujících namespaces, abyste vytvořili prostor pro nový namespace. Proveďte to podle předchozí sekce. 

2. Vytvořte nový namespace v projektu pomocí tlačítka UI a nastavte některé kvóty zdrojů.

![create-ns](/img/ceritsc/create-ns.png)  

4. Vytvořte následující role binding v novém namespace. Nové namespaces mají zakázáno provádět jakékoli akce, takže abyste zajistili, že můžete nasadit objekty, je tento role binding nezbytný. Můžete vytvořit rolebinding prostřednictvím UI nebo pomocí kubectl.

YAML rolebinding:
```yaml copy filename="rolebinding.yaml"
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: [new_namespace_name]-sa-rb
  namespace: [new_namespace_name]
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: grant-namespace-permissions
subjects:
- kind: ServiceAccount
  name: default
  namespace: [new_namespace_name]
```

Kubectl: Změňte `[new_namespace_name]` na skutečný název vašeho nového namespace, uložte ho jako např. `rolebinding.yaml` a nasadíte pomocí `kubectl create -f rolebinding.yaml`

UI: Navigujte podle obrázku a importujte stejný YAML jako výše, přičemž změňte `[new_namespace_name]` na skutečný název vašeho nového namespace.

![rolebinding](/img/ceritsc/rolebinding.png)


## Limity zdrojů

Pokud běžící kontejner překročí limity, výsledek závisí na typu zdroje. Pokud je zdrojem CPU, kontejner pokračuje v běhu, pouze CPU je omezeno, tj. běží pomaleji. Pokud je zdrojem paměť nebo dočasné úložiště, kontejner je *vysídlen*, může být restartován v případě *Nasazení*, ale zdroj není automaticky rozšířen, takže k vysídlení pravděpodobně dojde znovu.

## Důsledky

* Každý Pod, Job, Nasazení a jakýkoli jiný typ, který spouští kontejner, potřebuje atribut *resources*, jinak je nasazení odmítnuto s podobnou chybou:
```
Pods "master-685f855ff-gg9sr" is forbidden: failed quota: default-w2qv7: must specify limits.cpu,limits.memory,requests.cpu,requests.memory:Deployment does not have minimum availability.
```
 Nicméně, to by se uživateli nemělo stát, protože jsme nastavili výchozí zdroje kontejneru na 1 CPU a 512 MB paměti pro jak *požadavky*, tak *limity*. Tento výchozí stav se aplikuje pouze v případě, že uživatel nezadal zdroje.

* Kvóty nelze překročit, takže součet kvót pro všechny namespace v rámci projektu nesmí být větší než kvóta projektu. Jelikož jsme nastavili počáteční kvótu *namespace* na úroveň *projektu*, není prostor pro další namespace. Uživatelé mohou vytvořit další namespace, ale musí nejprve snížit kvóty na počátečním *namespace* nebo požádat o zvýšení kvót *projektu*.

* Pokud uživatelé nasadí více kontejnerů, než kvóta umožňuje, *Pods* jsou okamžitě odmítnuty, *Jobs* a další typy nasazení čekají, dokud nebudou k dispozici volné zdroje v rámci kvóty.

* Nastavení kvót na zdroje GPU v současnosti není možné.
