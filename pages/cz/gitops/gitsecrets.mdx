# Ukládání Kubernetes Secrets do Gitu

Jakmile máte nakonfigurovanou aplikaci Kubernetes, pravděpodobně budete chtít uložit její YAML soubory do git repozitáře pro účely správy verzí. Zde se však setkáváme s problémem -- Secret. Ukládání tajných YAML souborů do gitu je špatný nápad, protože pokud někdo získá přístup k našemu git repozitáři, bude schopen zobrazit tajemství v prostém textu.

Následující článek vysvětluje, jak bezpečně ukládat Kubernetes tajemství do gitu.

## Požadavky
- Namespace ve vašem clusteru
- kubectl
- kubeseal

## Instalace Kubeseal

Pro bezpečné ukládání Secret budete potřebovat program nazvaný `kubeseal`. Tento program si můžete stáhnout jako samostatný binární soubor z tohoto [GitHub repozitáře](https://github.com/bitnami-labs/sealed-secrets/releases).

## Jak uložit Secret

Nejprve budete potřebovat YAML soubor definující váš Secret, například takto (všimněte si, že data Secretu musí být zakódována v base64):

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: my-very-secret-data
  namespace: my-namespace
type: Opaque
data:
  universe: NDIK
```

Nyní převedete svůj Secret na `Sealed Secret`, což znamená, že data vašeho Secretu budou zašifrována pomocí náhodně vybraného klíče, tento klíč bude poté zašifrován pomocí veřejného šifrovacího klíče Kubernetes a připojen k sealed secret. V tomto okamžiku bude pouze Kubernetes schopen dešifrovat obsah Secretu pomocí svého soukromého dešifrovacího klíče, a proto je bezpečné uložit sealed secret do git repozitáře.

Můžete převést svůj Secret na sealed secret vydáním tohoto příkazu:

`kubeseal --controller-namespace sealed-secrets-operator < my-secret.yaml > sealed-secret.json`

Nyní byste měli mít soubor `sealed-secret.json` ve svém pracovním adresáři, obsah tohoto souboru by měl vypadat přibližně takto:

```json
{
  "kind": "SealedSecret",
  "apiVersion": "bitnami.com/v1alpha1",
  "metadata": {
    "name": "my-very-secret-data",
    "namespace": "my-namespace",
    "creationTimestamp": null
  },
  "spec": {
    "template": {
      "metadata": {
        "name": "my-very-secret-data",
        "namespace": "my-namespace",
        "creationTimestamp": null
      },
      "type": "Opaque",
      "data": null
    },
    "encryptedData": {
      "universe": "AgDJ9G4B918NCylKcFjY1j7vISrQvi+vOF38qZ+a8XyANUI3Qbif/BMw20zbAN9LnsQgQnTF8wxffgCSbENztfbVegNoTS6QhfXKYI3olaAmRa1Fntq2K2Lrw23dfVKhxuASX3XLq/mIM2ujF7Q7VuzRYERCHSOIyRNdTZLhwv0SCRGLUu/xBGxGhQSYy1M+ZAyjSIFtF3DgDYeMwy4uuaBHm8FE7BRp+wTfAPZcT8q9j0P1GokiWIv+GZpNia4WINazigO7PnHZzgQcPtap5K/Ekp53CN20SZ1tf2EBL4OatbHS2+/y7q3zv3KkwWNus+1aDj4yvZkNPP50AshW+Sqx0O7STdzc7Svl33flUrsJosm35uY/WwvfNqvdWTs0AN68BeBtWOCapC5USFum1wGuMb5BCi16cmDgcdaJ0Ii+uAszsh9TfwhFxfvz9ep2Pu0FWPgPliEIC1DumqpNm5RUA484Uq4nscfqqG7YpVqm9pnX59NUgBDDTeLoLCHh+u+SlcVYJtoNoN18t0FYqkNXAUDpRWGwjbwHr2C3/8YdFAOo7vr1OxOQNLpK080GSIrVQElUJlrazBQ801aq3kwDI1s7XYCXyKjljldnt1oz37sBIr6wTeOuQcsw4GbgNY87Ha1o19uLyoZyg8hv0xK5dZGbCHl6P4zZgI96zCadUE6Eg/bn6bqKZYgsJuPkyub2oJo="
    }
  }
}
```

Nyní můžete aplikovat své sealed secret pomocí `kubectl` takto:

`kubectl apply -f sealed-secret.json -n my-namespace`

Nyní byste měli vidět svůj Secret dešifrované uvnitř vašeho namespace.

![secret](/img/ceritsc/gitops/secret.png)

## Bezpečnost

Spolu s šifrovacím klíčem jsou také zašifrována jméno Secretu a požadovaný namespace a přidána k `Sealed Secret`. To zajišťuje, že sealed secret může být nainstalován pouze do původně zamýšleného namespace. To brání zlovolným uživatelům aplikovat vaše sealed secret do jejich namespace, aby mohli zobrazit dešifrovaná data.
