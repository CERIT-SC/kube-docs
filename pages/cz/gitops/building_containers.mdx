# Vytváření Docker kontejnerů s GitLab

Tento tutoriál ukazuje, jak nastavit základní GitLab pipeline pro automatické vytváření Docker image a jeho publikaci do kontejnerového registru.

## Požadavky
- GitLab repozitář
- Dockerfile v repozitáři s požadovanou konfigurací kontejneru

## Konfigurace CI/CD GitLab Pipeline souboru
- Ve vašem požadovaném repozitáři použijte tlačítko **Nastavit CI/CD** jak je znázorněno na následujícím obrázku. 
![setup](/img/ceritsc/gitops/containers_1.png)

- V editoru `.gitlab-ci.yml` zkopírujte a vložte následující úryvek:    

```yaml filename=".gitlab-ci.yml" copy
docker-build:
  image: docker:latest
  stage: build
  services:
    - docker:dind
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - |
      if [[ "$CI_COMMIT_BRANCH" == "$CI_DEFAULT_BRANCH" ]]; then
        tag=""
        echo "Running on default branch '$CI_DEFAULT_BRANCH': tag = 'latest'"
      else
        tag=":$CI_COMMIT_REF_SLUG"
        echo "Running on branch '$CI_COMMIT_BRANCH': tag = $tag"
      fi
    - docker build --pull -t "$CI_REGISTRY_IMAGE${tag}" .
    - docker push "$CI_REGISTRY_IMAGE${tag}"
  rules:
    - if: $CI_COMMIT_BRANCH
      exists:
        - Dockerfile
```
To použije standardní GitLab Container Registry dostupný ve vašem projektu. Všimněte si proměnné `$CI_REGISTRY`, která je specifická pro repozitář.

- Potvrďte změny 
![commit](/img/ceritsc/gitops/containers_2.png)

- Pipeline bude spuštěna a její stav může být zobrazen v informacích o posledním commitu.
![pipeline_status](/img/ceritsc/gitops//containers_3.png)
Pro seznam úloh pro danou pipeline navštivte `CI/CD > Pipelines`
![pipelines](/img/ceritsc/gitops//containers_4.png)

Pokud úloha pipeline uspěje, čerstvě vytvořený image kontejneru bude nahrán do GitLab kontejnerového registru.   
`Packages & Registries > Container registry` je dostupné zde:
![sda](/img/ceritsc/gitops//containers_5.png)

Pro pokročilé informace se prosím odkažte na [oficiální dokumentaci](https://docs.gitlab.com/ee/user/packages/container_registry/#container-registry-examples-with-gitlab-cicd)

## Jak používat obrázky z GitLab registru

Pokud je viditelnost projektu v GitLab veřejná a kontejnerový registr není omezen na autentizované uživatele, jednoduše použijte:

```bash
docker run [options] registry.example.com/group/project/image [arguments]
```

> Pokud používáte MUNI ICS GitLab, URL registru je: registry.gitlab.ics.muni.cz

Pokud je viditelnost projektu nebo kontejnerový registr nastaven na soukromý, je potřeba autentizace do kontejnerového registru. Budete muset vytvořit deploy token a použít ho, jak je popsáno v [oficiální dokumentaci](https://docs.gitlab.com/ee/user/packages/container_registry/#authenticate-with-the-container-registry)

Pro více informací se prosím odkažte na [oficiální dokumentaci](https://docs.gitlab.com/ee/user/packages/container_registry/#use-images-from-the-container-registry).

## Nahrání obrázku do vlastního kontejnerového registru
Změňte možnosti příkazu `docker login` v části `before_script` vaší definice pipeline (`gitlab-ci.yml`). 

```yaml
  before_script:
    - docker login -u "uživatelské_jméno" -p "heslo" example.io
```
