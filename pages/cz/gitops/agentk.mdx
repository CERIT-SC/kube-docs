# GitLab Kubernetes Agent

Následující text popisuje, jak nainstalovat GitLab Kubernetes Agent krok za krokem.

Dodržováním těchto kroků byste měli mít funkční agenta a znalosti o vytváření manifestních souborů.

## Požadavky
- Namespace ve vašem clusteru
- GitLab repozitář
- kubectl


## Definujte konfigurační repozitář

Ve vašem požadovaném repozitáři přidejte konfigurační soubor agenta: `.gitlab/agents/<agent-name>/config.yaml`

Ujistěte se, že `<agent-name>` odpovídá [formátu pojmenování agenta](https://gitlab.com/gitlab-org/cluster-integration/gitlab-agent/-/blob/master/doc/identity_and_auth.md#agent-identity-and-name).

```yaml
gitops:
    manifest_projects:
        - id: <Your Project ID>
          default_namespace: <Your Namespace>
          paths:
              - glob: '/manifest/*.{yaml,yml,json}'
```

**Poznámka**: `<Your Project ID>` může být nahrazen vaší cestou k projektu.


## Připojte se k clusteru

- Zaregistrujte agenta a získejte token agenta.
  
  Ve vašem projektu přejděte na: 
  
  Infrastruktura -> Kubernetes clustery -> Nainstalovat nového agenta 
  ![agentk1](/img/ceritsc/gitops/agentk1.png)
  
  Vyberte agenta -> Registrovat
  ![agentk2](/img/ceritsc/gitops/agentk2.png)
  
  Objeví se token agenta, zkopírujte ho. Buďte opatrní, token není přístupný dvakrát.
  
- Vytvořte neprůhledné tajemství s názvem `gitlab-kubernetes-agent-token` s `klíčem pojmenovaným token`, `hodnota=<Your Agent Token>`
  
  Pomocí kubectl: `kubectl create secret generic -n <Your Namespace> gitlab-kubernetes-agent-token --from-literal=token=<Your Token>`

- Stáhněte soubor nasazení [resources.yaml](../kubernetes/resources.yaml).
  
  V souboru, v této části:
  
  ```yaml
  apiVersion: rbac.authorization.k8s.io/v1
  kind: Role
  metadata:
    name: gitlab-kubernetes-agent-role
  rules:
  - resources: ["configmaps", "secrets", "pods"]
    apiGroups: 
    - ""
    verbs: ["get", "list", "watch", "create", "update", "delete", "patch"]
  - resources: ["deployments", "statefulsets"]
    apiGroups:
    - "apps"
    verbs: ["get", "list", "watch", "create", "update", "delete", "patch"]
  ```
  
  Určete zdroje a akce podle vašeho výběru. 
  Všechny zdroje, ke kterým máte oprávnění, můžete vypsat tímto příkazem `kubectl api-resources --verbs=list -n <Your Namespace>`

- Aplikujte nasazení následujícím příkazem:
`kubectl apply -n <Your Namespace> -f resources.yaml`

- Zkontrolujte, zda agent běží. Buď v Rancheru, nebo pomocí kubectl `kubectl get pods -n <Your Namespace>`

## Správa nasazení

- Ve vašem repozitáři vytvořte manifestní soubor: `/manifest/manifest.yaml`
 
 
Pro účely testování agenta vytvoříme jednoduchý manifestní soubor, který vytvoří ConfigMap v `<Your Namespace>`.

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: test-map
  namespace: <Your Namespace>  # Can be any namespace managed by you that the agent has access to.
data:
  key: value
```

Pokud vše proběhlo hladce, měli byste mít ConfigMap s názvem test-map.
***
